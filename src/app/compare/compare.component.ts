import {
  Component,
  ViewChild,
  OnInit,
  ElementRef,
  AfterViewInit,
  ComponentFactoryResolver,
  ViewContainerRef,
  Renderer2,
  HostListener
} from '@angular/core';

import * as d3 from 'd3';

import { DataService } from '../services/data.service';
import { DataSharingService } from '../services/data-sharing.service';

import { Widget } from '../widget';

import { BarChartComponent } from '../bar-chart/bar-chart.component';
import { BoxPlotComponent } from '../box-plot/box-plot.component';

// widgets
//////////////////////////////////
interface WidgetType {
  key: string;
  type: string;
  widget: Widget;
}

@Component({
  selector: 'app-compare',
  templateUrl: './compare.component.html',
  styleUrls: ['./compare.component.scss']
})
export class CompareComponent implements OnInit, AfterViewInit {

  dim = 'department';

  features = [{ "feature": { "type": "Feature", "geometry": { "type": "Polygon", "coordinates": [[[4.8004899840029, 45.298357121937], [4.8588038161436, 45.308951945608], [4.8586100908504, 45.29851618808], [4.8802416809906, 45.2974566456], [4.9012637445124, 45.310007436763], [4.9284388130601, 45.322951204602], [4.9475761450964, 45.328597843474], [4.9595854101246, 45.328918743796], [4.9891862167152, 45.344042230781], [5.0096495089118, 45.342230172467], [5.0205931755981, 45.319428254027], [5.0543224224169, 45.319051008949], [5.0591074575312, 45.313623430692], [5.0754112531922, 45.281827518251], [5.0910708813282, 45.286770048947], [5.1122870741104, 45.289758183582], [5.1255573347389, 45.298558532685], [5.1385253524837, 45.296216167914], [5.131354968047, 45.286531093128], [5.1301773389705, 45.267206969934], [5.1256631119512, 45.26209101661], [5.1214293208332, 45.248334945441], [5.1314466193386, 45.243321691602], [5.1414710173246, 45.245014424938], [5.1519149109729, 45.255479740823], [5.156679209512, 45.247392718624], [5.1765458684418, 45.248399245404], [5.1853651989338, 45.230539570693], [5.2017183191657, 45.217400467946], [5.1787087939172, 45.216974316616], [5.1674873703836, 45.210221645731], [5.1648771309633, 45.198450714497], [5.1694383011753, 45.195274384832], [5.1770838978704, 45.179740593678], [5.1885746038112, 45.171264013519], [5.191700424762, 45.154576461872], [5.1868446925336, 45.145105728237], [5.187438201276, 45.120832355985], [5.176310666063, 45.107822675236], [5.1628941235196, 45.098426086784], [5.1564001681613, 45.082786398559], [5.1427276255164, 45.080729882348], [5.1472802619812, 45.072549217506], [5.1634833877489, 45.06599819123], [5.1793794005119, 45.083305819247], [5.1833351592236, 45.084878534921], [5.2082043994035, 45.084220045879], [5.2261246446959, 45.07918137092], [5.2303765814513, 45.072500129754], [5.2445180483487, 45.066971920702], [5.2483439776641, 45.060930865772], [5.2662685281178, 45.059810966567], [5.2918748938355, 45.063928670512], [5.300644528137, 45.062587690778], [5.3074190056319, 45.053404696516], [5.3170937420842, 45.051443710709], [5.334790878464, 45.060805233498], [5.3431185907943, 45.059779112552], [5.3437881719066, 45.051703899543], [5.3507319764542, 45.047203142466], [5.3713895477672, 45.0438762945], [5.3883853627744, 45.036136409191], [5.3972657713912, 45.038330859223], [5.3963847959196, 45.044550028371], [5.4088425346067, 45.044735225212], [5.417792323715, 45.048366081468], [5.4257108891404, 45.05626514626], [5.4497902629449, 45.070787231096], [5.4594178157294, 45.084353288913], [5.4683829045497, 45.088079984604], [5.482960100439, 45.083814042465], [5.4888280786289, 45.073091937552], [5.4773643019715, 45.072025935069], [5.4662213802966, 45.053689072581], [5.4648455525186, 45.045940903248], [5.4836143274431, 45.022786934023], [5.4804589043527, 45.013865278458], [5.4884745473303, 45.001223430328], [5.4887669714919, 44.990232279193], [5.4776757133828, 44.966755171398], [5.4836507785865, 44.922286913688], [5.480315188243, 44.896807670531], [5.4700479073037, 44.879032502847], [5.4750760812667, 44.867592273489], [5.46606801453, 44.841221723762], [5.4637975227518, 44.825974431714], [5.4837019416551, 44.823184908254], [5.4767736644408, 44.81563556844], [5.4760803164135, 44.809091676298], [5.4624328748393, 44.802667812109], [5.4641599003636, 44.792424769087], [5.4949322129004, 44.782627931299], [5.5196122819033, 44.777219870899], [5.5555318108241, 44.771216999345], [5.5441427350362, 44.788922680811], [5.549761645604, 44.794528877128], [5.5820961321703, 44.777685016074], [5.5838826069396, 44.765344858953], [5.5899964337532, 44.761617860814], [5.6270859672246, 44.752460799598], [5.6315009068421, 44.738825957841], [5.64398076712, 44.73157541049], [5.6470991996242, 44.724099914037], [5.6682357861974, 44.724714054907], [5.6987857560456, 44.722066559691], [5.7052357370695, 44.727685225843], [5.7193970657268, 44.71376644489], [5.7417693832802, 44.710673317311], [5.7451471861505, 44.703727044556], [5.7590439457666, 44.696067584965], [5.7853372486465, 44.700829290463], [5.8014699513145, 44.706777613167], [5.8271099006445, 44.700288039663], [5.8294720463131, 44.692425284611], [5.8246351320469, 44.685278024621], [5.8064797515589, 44.677181975541], [5.790623681681, 44.653292905762], [5.7666311555846, 44.655266851559], [5.7539428619931, 44.662710867987], [5.748257168346, 44.655090844363], [5.7511047252626, 44.648611621404], [5.7360131774513, 44.649510358823], [5.7358025109287, 44.640415596891], [5.7260329075738, 44.639393999475], [5.6853621391431, 44.649596345809], [5.6593597358465, 44.650663453626], [5.6544567435058, 44.655393257217], [5.6417177024073, 44.65107732796], [5.6403729488497, 44.633825447345], [5.6496311179712, 44.617884606434], [5.6475161192881, 44.612808143065], [5.6274790368545, 44.594965971046], [5.6257986898421, 44.586275880643], [5.6070190339977, 44.568348424227], [5.5997980521304, 44.553941311612], [5.5972525723721, 44.543273639184], [5.6149927369414, 44.532817987531], [5.630802337654, 44.531597332459], [5.6531427146706, 44.514831250068], [5.6645041823511, 44.501894932126], [5.6526558596497, 44.499962952183], [5.6297876074114, 44.501187043038], [5.618123153083, 44.474812657295], [5.6036448321495, 44.465542446118], [5.5792007067241, 44.471686064395], [5.5703041972283, 44.476754841678], [5.5624010016641, 44.474853738869], [5.5447008857046, 44.482537575762], [5.5133416154223, 44.491125991349], [5.479877306738, 44.491243239804], [5.4735960069771, 44.498568843239], [5.4653894088793, 44.500459334817], [5.4569314822479, 44.496235778443], [5.463575747607, 44.480512627606], [5.4587312484193, 44.466142946772], [5.4640494490072, 44.457360043051], [5.4644276220352, 44.447890408205], [5.496803836369, 44.438493779503], [5.4936153322299, 44.428217653577], [5.4865672289608, 44.429310933518], [5.4764846044694, 44.419722107544], [5.4507590745848, 44.430873511581], [5.4338571063313, 44.433224179441], [5.4185330627929, 44.424944615913], [5.422756262532, 44.416770650479], [5.434309527365, 44.409479438419], [5.4430201938352, 44.391233871018], [5.4423608910239, 44.381659799255], [5.4351137570212, 44.37707693084], [5.4344154288602, 44.36962646376], [5.4629658844687, 44.367052180352], [5.4679488171996, 44.352676849629], [5.4824720338071, 44.349605960068], [5.4930701487957, 44.337173950444], [5.5135447821727, 44.347485508397], [5.5398634524253, 44.342637263297], [5.5373655887575, 44.333521248655], [5.5491114786402, 44.330396465555], [5.5738598675994, 44.333940368466], [5.5868917748447, 44.332226010325], [5.6171385399181, 44.332478533509], [5.6269152221035, 44.334764537726], [5.6315982014425, 44.32830571643], [5.6138324838557, 44.316139439714], [5.6079060792589, 44.306669558882], [5.6377527896773, 44.29968895608], [5.6332659808825, 44.282119871541], [5.6467811994158, 44.267088776629], [5.6752912853484, 44.275852112257], [5.6865615009091, 44.266921017987], [5.6753443584242, 44.258110993228], [5.6726438758953, 44.245665214395], [5.6813154432669, 44.232890979586], [5.6760207339785, 44.212146588276], [5.6864432188187, 44.197157935534], [5.6760358633349, 44.191428664539], [5.6515861240321, 44.189572730485], [5.6522929653271, 44.185411124162], [5.6436911140627, 44.172641360479], [5.6469586945897, 44.166287300205], [5.6626325073952, 44.16686426058], [5.6827091460673, 44.163217461898], [5.6786089032088, 44.146091300526], [5.6679496679388, 44.148873764468], [5.65770809672, 44.147529418679], [5.6311399737751, 44.150576623162], [5.6395945851702, 44.167581524], [5.6162160024561, 44.181069460057], [5.6020555143928, 44.191496296599], [5.5962058311559, 44.187648959302], [5.5761919645305, 44.188037035508], [5.5643706424911, 44.170901794193], [5.5829754941585, 44.157625987959], [5.5695065039633, 44.148099520416], [5.5513311325106, 44.149791971653], [5.5439848356077, 44.136389912148], [5.5329588653579, 44.130053463575], [5.5197573760784, 44.126616149895], [5.5048243383524, 44.116270397321], [5.4987864391759, 44.115716677493], [5.4547151332789, 44.119226133429], [5.4492512328028, 44.124591922526], [5.4472805287304, 44.135994708471], [5.4369459430348, 44.142812945214], [5.4357509062277, 44.152249650949], [5.3905234132549, 44.1534251894], [5.3832371388833, 44.155284811726], [5.3864765223646, 44.1769070133], [5.3830416498971, 44.198796138337], [5.3845269211658, 44.20104933819], [5.3540415690827, 44.213431973111], [5.336784174291, 44.20389269414], [5.3183111725222, 44.209869282984], [5.3037098672957, 44.206011143284], [5.2911909842134, 44.214933969307], [5.2565049248197, 44.230055506], [5.2404514324301, 44.230825507739], [5.2381459551442, 44.213233409548], [5.2046138867346, 44.215116852293], [5.1735074807317, 44.2219664549], [5.1548996659898, 44.230941470835], [5.1516592069293, 44.23772859876], [5.1615500254058, 44.245588822308], [5.1571364176122, 44.267225182448], [5.1474716753569, 44.269525185767], [5.1497309928727, 44.282086494235], [5.1672051148975, 44.292050008972], [5.1726899918655, 44.309391119528], [5.1664353137721, 44.314853482023], [5.1524172226752, 44.307683682999], [5.1546757377907, 44.301844910979], [5.1214657621262, 44.287480229186], [5.1078521429136, 44.280398126188], [5.0765144884036, 44.284084169033], [5.0605607254823, 44.308137131551], [5.0384946811178, 44.299637776655], [5.0218466033995, 44.295587171529], [5.0069116240356, 44.287554489231], [4.9814530758182, 44.284833474448], [4.9598922113805, 44.274192870866], [4.935492573713, 44.264314996193], [4.9175325402435, 44.260348620291], [4.9060631576886, 44.260294315057], [4.8961483935046, 44.264431155121], [4.8737563985909, 44.25925825523], [4.845368774508, 44.241470533268], [4.8266501157802, 44.228322408488], [4.814089831112, 44.232314781729], [4.8126620207402, 44.257716427139], [4.8052938582648, 44.268723026395], [4.8028804076615, 44.296593704504], [4.7991000020835, 44.303525444918], [4.7825467521402, 44.315582694107], [4.7622549890071, 44.325381622419], [4.7201274920268, 44.326711236709], [4.7130169314739, 44.320649375535], [4.6790253292764, 44.320490236187], [4.6506111734968, 44.329803148128], [4.6477668446587, 44.345435285153], [4.6489499333936, 44.372462429925], [4.6643671500128, 44.398945267903], [4.6631054744838, 44.408193195403], [4.6673737105298, 44.430666189382], [4.6717207236289, 44.435575882037], [4.6913719125076, 44.441606696117], [4.698652294125, 44.452309460148], [4.7008111306551, 44.465407726847], [4.6989569043439, 44.481695990615], [4.6899681580394, 44.491246162058], [4.6882016564414, 44.505507967849], [4.6920539362507, 44.51524108867], [4.7070188782854, 44.530840235114], [4.7007051593196, 44.539464850247], [4.6936369285978, 44.542226212664], [4.692360716096, 44.555893769347], [4.7024424953059, 44.559506257526], [4.7070086082734, 44.566482686877], [4.704913461242, 44.573681746966], [4.7102689640623, 44.581547275665], [4.7411702191089, 44.588775228937], [4.7443818072321, 44.600825092206], [4.7404056572708, 44.602387973218], [4.7577811710486, 44.626516889843], [4.7580893573914, 44.630738870999], [4.7740878762465, 44.644269863496], [4.7790663353968, 44.654696002617], [4.7790828544927, 44.679075999709], [4.7811112562781, 44.682832714353], [4.7735508584443, 44.696632002958], [4.770855857691, 44.707768588968], [4.7628468154066, 44.720092999967], [4.7642764416701, 44.730364078236], [4.7606865181698, 44.744264950792], [4.7693074766224, 44.760200259528], [4.7618527499152, 44.769443231368], [4.7662167518672, 44.778624979068], [4.7793490242908, 44.783077055445], [4.7930647721326, 44.791879535102], [4.7972592039065, 44.804483283812], [4.8105773806198, 44.816126997605], [4.8225169914307, 44.8170913827], [4.8198499279442, 44.834752945224], [4.8216552765179, 44.838672317135], [4.8413382097893, 44.84259184781], [4.8447690858272, 44.858253583993], [4.859459415011, 44.871750531479], [4.8606144550499, 44.880768615779], [4.8547290164414, 44.889766730461], [4.8579025066681, 44.903157789874], [4.8681634355011, 44.909105291004], [4.8715218455763, 44.917803545397], [4.8865943991285, 44.936652444616], [4.8756803593057, 44.955208796322], [4.8601662520968, 44.965858918892], [4.8525687570978, 44.97953099948], [4.8512610496739, 44.994680465822], [4.8376738035274, 45.004788192487], [4.8374888293491, 45.01172602474], [4.8452075327059, 45.022221191798], [4.8403350665335, 45.035786029276], [4.8540950735802, 45.046251864428], [4.8607510889061, 45.055427319327], [4.8526119061642, 45.064235228454], [4.8316486153953, 45.070271179144], [4.8276625497628, 45.077965908196], [4.8318453392336, 45.089670350352], [4.8273592772733, 45.102145788995], [4.8178949574706, 45.108198810951], [4.8044870212281, 45.121943298284], [4.8044647656159, 45.133193548442], [4.8244322155718, 45.148380577457], [4.8291002542524, 45.156686506903], [4.8124687887878, 45.164479213676], [4.8090522119215, 45.170900439855], [4.8120267158556, 45.179930757264], [4.8048124767787, 45.194033858288], [4.8125634562269, 45.204310887013], [4.8025808522447, 45.226933954961], [4.8022063840458, 45.248326201056], [4.8102641176881, 45.263906311762], [4.8094568553149, 45.289844279254], [4.8004899840029, 45.298357121937]], [[4.8881212108854, 44.331685388726], [4.8816338901906, 44.324867070891], [4.8898043773976, 44.314637092176], [4.8895301353902, 44.304153097826], [4.9221541568202, 44.308786460381], [4.9451171535381, 44.304930431589], [4.9592140611525, 44.300383345912], [4.9785833048477, 44.29746123871], [4.9872903058308, 44.293201871035], [4.9931295821934, 44.314275867797], [5.0133769832902, 44.326136687081], [5.0090024588591, 44.333764157861], [5.0232851187488, 44.345948323084], [5.0217054810597, 44.35674765583], [5.0270113166527, 44.362835272711], [5.0520104655825, 44.364657329845], [5.0715584929227, 44.377495636793], [5.0708829483659, 44.383226380932], [5.0450881649883, 44.38222013058], [5.033568721145, 44.391088844502], [5.0157545106617, 44.392767137778], [5.0133020500209, 44.405342926953], [5.0187537016752, 44.415979484324], [5.0010692090687, 44.412604850416], [4.9886124577738, 44.423200264487], [4.9786944339347, 44.423476108149], [4.9704375593477, 44.431367227183], [4.960461816094, 44.420048061058], [4.9185138149855, 44.407786865574], [4.9123797297803, 44.399635600585], [4.9117660520568, 44.387044638589], [4.9066213399272, 44.374101025322], [4.893168871015, 44.367875394193], [4.8906819005659, 44.359781959098], [4.8753963679389, 44.351439190756], [4.8796465016088, 44.345346527391], [4.8953267719183, 44.338062405104], [4.8881212108854, 44.331685388726]]] }, "properties": { "code": "26", "nom": "Drôme" } }, "constraints": "/query/dataset=health-markers/const=department.values.(all)/const=event_date.interval.(946857600:1500595200)/const=department.vales.(26)" }, { "feature": { "type": "Feature", "geometry": { "type": "Polygon", "coordinates": [[[5.62374290574, 45.613268446443], [5.6230208703548, 45.604282743022], [5.6430941654947, 45.585618310022], [5.6470817885996, 45.57674261279], [5.654825526768, 45.570120639284], [5.6695358905937, 45.563199459718], [5.6803575756273, 45.545047248369], [5.6717082687622, 45.536571381592], [5.6768487183882, 45.530475432419], [5.6901528196542, 45.52805100678], [5.6912470759998, 45.521805232869], [5.7011064065529, 45.517546444671], [5.70267342317, 45.511196354762], [5.7125099215192, 45.505293631893], [5.7190481261138, 45.484227733066], [5.7363772302151, 45.472535799856], [5.7322100567066, 45.453663170363], [5.7400977980128, 45.437349988759], [5.7597939416716, 45.435261281179], [5.7634821589831, 45.439042972367], [5.7820850307141, 45.440656144128], [5.7979610020218, 45.437123711786], [5.8074478270167, 45.426270640914], [5.8232128524879, 45.421771370243], [5.8542752462907, 45.4165640969], [5.8607139660775, 45.40924651344], [5.8797333382597, 45.406797743306], [5.8917060274354, 45.398132080514], [5.8910055457909, 45.392211292218], [5.909612774011, 45.390400457607], [5.9149860828604, 45.401349288339], [5.9281112911718, 45.415471973855], [5.9226358813528, 45.416818739345], [5.9090423346643, 45.408294208274], [5.9016155577899, 45.418032646134], [5.904472446297, 45.432574848416], [5.9149042257548, 45.436653554682], [5.9254150387228, 45.464593457788], [5.9164085799586, 45.47667987803], [5.9533584581804, 45.484809788706], [5.9661721637538, 45.492307753934], [5.9821187808525, 45.487027235821], [5.9893333893021, 45.476074199105], [6.0109047885983, 45.47320486613], [6.0085163401932, 45.453848085956], [6.0497526230096, 45.437920464227], [6.0658423549871, 45.444139208117], [6.0909753082569, 45.444016847857], [6.0974519491338, 45.432105098885], [6.1212683533751, 45.438895252904], [6.1324998100528, 45.433380436097], [6.1436456530595, 45.414580875157], [6.154793328964, 45.409336349236], [6.1774532351909, 45.393156916781], [6.1860529913803, 45.374350928001], [6.1916877134761, 45.369022157094], [6.1802922696297, 45.360409426774], [6.1803709629809, 45.35492081739], [6.19476040795, 45.352244568075], [6.1900932248736, 45.342443964482], [6.1844454256034, 45.317952251676], [6.1632323695733, 45.312838044143], [6.1417688736284, 45.299001113002], [6.1319486525639, 45.288285309432], [6.1325841534867, 45.272593012456], [6.1393900781341, 45.266560839079], [6.1385812548773, 45.256050997267], [6.1257002517953, 45.244269262231], [6.1272723570602, 45.233317943724], [6.1416935060053, 45.22232847567], [6.1378211482236, 45.213333187699], [6.1594722938627, 45.202449604679], [6.1619191434924, 45.188405431434], [6.143792292215, 45.154552997649], [6.1613170230868, 45.151005539601], [6.1690294070189, 45.154126275916], [6.1759369876508, 45.162361766933], [6.1892075903757, 45.163730483941], [6.2159372176736, 45.152163633175], [6.2183492305743, 45.145333575225], [6.2277116468863, 45.142717265929], [6.2489312476442, 45.149662771802], [6.2653779890371, 45.139607411594], [6.2605698000566, 45.12684420383], [6.2544936755586, 45.120790168264], [6.2438305270389, 45.117298075856], [6.2293919345611, 45.108749945384], [6.2296723977867, 45.100589085615], [6.2358324302027, 45.087232804381], [6.2401205372094, 45.06771808518], [6.2200802599652, 45.065369735518], [6.2063284689408, 45.026782796498], [6.2039233205269, 45.012471073947], [6.2517609476002, 44.996700081455], [6.2696990840472, 44.998351365091], [6.2970615457571, 45.003365126963], [6.3182021615637, 45.003859362058], [6.3196573396763, 44.994552811249], [6.3148100239742, 44.980185922577], [6.3285012874077, 44.969714464603], [6.3229180108318, 44.953019839313], [6.3290046114892, 44.947315364095], [6.3588423781754, 44.941280796729], [6.3546140951868, 44.923593300625], [6.3581697523493, 44.893778946012], [6.3507779137165, 44.881204072575], [6.3553625022057, 44.854775353601], [6.3363165518362, 44.848370410548], [6.3192302042703, 44.85684625453], [6.302850434726, 44.873257969643], [6.2882129459689, 44.874030533685], [6.2677561761734, 44.86950109295], [6.2581706057376, 44.86248397325], [6.2505425682344, 44.852650516632], [6.2243745547304, 44.852494101643], [6.1963759402105, 44.858978334449], [6.1852192319643, 44.853991864943], [6.1684510585274, 44.852242761941], [6.1490188906075, 44.858169876067], [6.1362266704196, 44.864071820118], [6.1283556561161, 44.861901713563], [6.1166725017074, 44.849313192704], [6.1007058869493, 44.84257849233], [6.0965156572897, 44.837489421771], [6.0653153781591, 44.82268480473], [6.0563403817425, 44.815907431783], [6.0402065129253, 44.827867468677], [6.0302157011626, 44.838097758941], [6.0159331963205, 44.835485814051], [6.0048600553234, 44.820439050514], [5.9961657258664, 44.81787407617], [5.9781993713916, 44.818035522208], [5.9495216336669, 44.804527356596], [5.9537639530916, 44.799525853781], [5.9777793189449, 44.790983738721], [5.9801493330969, 44.781181602373], [5.9555147438847, 44.772449015839], [5.952471613503, 44.76214052281], [5.937984096823, 44.763046424986], [5.926812494728, 44.757135657325], [5.9152344231519, 44.754703072251], [5.900149637893, 44.758315310611], [5.8888310649581, 44.748803778249], [5.8794954997212, 44.747015345674], [5.8652264931802, 44.75155204943], [5.8503937497009, 44.750747373326], [5.8371577512142, 44.757677183301], [5.8270981940509, 44.759688387455], [5.8277714297865, 44.740086051546], [5.8177724444737, 44.730405199263], [5.8087945811456, 44.712101632921], [5.8014699513145, 44.706777613167], [5.7853372486465, 44.700829290463], [5.7590439457666, 44.696067584965], [5.7451471861505, 44.703727044556], [5.7417693832802, 44.710673317311], [5.7193970657268, 44.71376644489], [5.7052357370695, 44.727685225843], [5.6987857560456, 44.722066559691], [5.6682357861974, 44.724714054907], [5.6470991996242, 44.724099914037], [5.64398076712, 44.73157541049], [5.6315009068421, 44.738825957841], [5.6270859672246, 44.752460799598], [5.5899964337532, 44.761617860814], [5.5838826069396, 44.765344858953], [5.5820961321703, 44.777685016074], [5.549761645604, 44.794528877128], [5.5441427350362, 44.788922680811], [5.5555318108241, 44.771216999345], [5.5196122819033, 44.777219870899], [5.4949322129004, 44.782627931299], [5.4641599003636, 44.792424769087], [5.4624328748393, 44.802667812109], [5.4760803164135, 44.809091676298], [5.4767736644408, 44.81563556844], [5.4837019416551, 44.823184908254], [5.4637975227518, 44.825974431714], [5.46606801453, 44.841221723762], [5.4750760812667, 44.867592273489], [5.4700479073037, 44.879032502847], [5.480315188243, 44.896807670531], [5.4836507785865, 44.922286913688], [5.4776757133828, 44.966755171398], [5.4887669714919, 44.990232279193], [5.4884745473303, 45.001223430328], [5.4804589043527, 45.013865278458], [5.4836143274431, 45.022786934023], [5.4648455525186, 45.045940903248], [5.4662213802966, 45.053689072581], [5.4773643019715, 45.072025935069], [5.4888280786289, 45.073091937552], [5.482960100439, 45.083814042465], [5.4683829045497, 45.088079984604], [5.4594178157294, 45.084353288913], [5.4497902629449, 45.070787231096], [5.4257108891404, 45.05626514626], [5.417792323715, 45.048366081468], [5.4088425346067, 45.044735225212], [5.3963847959196, 45.044550028371], [5.3972657713912, 45.038330859223], [5.3883853627744, 45.036136409191], [5.3713895477672, 45.0438762945], [5.3507319764542, 45.047203142466], [5.3437881719066, 45.051703899543], [5.3431185907943, 45.059779112552], [5.334790878464, 45.060805233498], [5.3170937420842, 45.051443710709], [5.3074190056319, 45.053404696516], [5.300644528137, 45.062587690778], [5.2918748938355, 45.063928670512], [5.2662685281178, 45.059810966567], [5.2483439776641, 45.060930865772], [5.2445180483487, 45.066971920702], [5.2303765814513, 45.072500129754], [5.2261246446959, 45.07918137092], [5.2082043994035, 45.084220045879], [5.1833351592236, 45.084878534921], [5.1793794005119, 45.083305819247], [5.1634833877489, 45.06599819123], [5.1472802619812, 45.072549217506], [5.1427276255164, 45.080729882348], [5.1564001681613, 45.082786398559], [5.1628941235196, 45.098426086784], [5.176310666063, 45.107822675236], [5.187438201276, 45.120832355985], [5.1868446925336, 45.145105728237], [5.191700424762, 45.154576461872], [5.1885746038112, 45.171264013519], [5.1770838978704, 45.179740593678], [5.1694383011753, 45.195274384832], [5.1648771309633, 45.198450714497], [5.1674873703836, 45.210221645731], [5.1787087939172, 45.216974316616], [5.2017183191657, 45.217400467946], [5.1853651989338, 45.230539570693], [5.1765458684418, 45.248399245404], [5.156679209512, 45.247392718624], [5.1519149109729, 45.255479740823], [5.1414710173246, 45.245014424938], [5.1314466193386, 45.243321691602], [5.1214293208332, 45.248334945441], [5.1256631119512, 45.26209101661], [5.1301773389705, 45.267206969934], [5.131354968047, 45.286531093128], [5.1385253524837, 45.296216167914], [5.1255573347389, 45.298558532685], [5.1122870741104, 45.289758183582], [5.0910708813282, 45.286770048947], [5.0754112531922, 45.281827518251], [5.0591074575312, 45.313623430692], [5.0543224224169, 45.319051008949], [5.0205931755981, 45.319428254027], [5.0096495089118, 45.342230172467], [4.9891862167152, 45.344042230781], [4.9595854101246, 45.328918743796], [4.9475761450964, 45.328597843474], [4.9284388130601, 45.322951204602], [4.9012637445124, 45.310007436763], [4.8802416809906, 45.2974566456], [4.8586100908504, 45.29851618808], [4.8588038161436, 45.308951945608], [4.8004899840029, 45.298357121937], [4.7889343017658, 45.306705287082], [4.7699315539545, 45.31601418313], [4.7605327238034, 45.327460400164], [4.7613883954348, 45.34062730957], [4.7736174113958, 45.347659425308], [4.7725568146969, 45.35486629718], [4.75599963206, 45.365674921417], [4.7590198368357, 45.381472173695], [4.7558093145859, 45.396415196441], [4.7441167394752, 45.40888118257], [4.7447605342399, 45.421331112612], [4.7586674371295, 45.431094261452], [4.7604638818845, 45.437086232502], [4.7555294013359, 45.447048576794], [4.7569316195483, 45.455703808946], [4.7794738263144, 45.45503324486], [4.7822796715264, 45.472208128185], [4.8120086150016, 45.483343833967], [4.8272424509878, 45.49628139378], [4.841259965977, 45.500603648061], [4.8684816431075, 45.523437511407], [4.8728116747039, 45.531305267791], [4.8644436168106, 45.537346005002], [4.8401221979115, 45.543293629833], [4.8311024088019, 45.547770728452], [4.8086931363098, 45.572300631782], [4.7820837628775, 45.580581569271], [4.7771292183341, 45.587395458322], [4.8034791539416, 45.587537956161], [4.810043763556, 45.589552751649], [4.8577266463597, 45.5795777754], [4.8597792137897, 45.590828133064], [4.8729020897275, 45.595302229166], [4.8821976306935, 45.601571961358], [4.8927769429114, 45.601555646906], [4.9014588479373, 45.60626328191], [4.9275304060187, 45.605707819264], [4.936077557335, 45.608840645632], [4.9603757463763, 45.610073577685], [4.9719782401764, 45.612682039538], [4.9979604182227, 45.603410458278], [5.0019895947765, 45.61395165469], [4.9894470341835, 45.618525768193], [5.004740525885, 45.62311302936], [5.0380861620656, 45.615067173692], [5.0436466037904, 45.621332111414], [5.0351462071679, 45.637203894595], [5.044542399742, 45.647272778433], [5.0580570584302, 45.653246417357], [5.0542255730691, 45.660136259749], [5.0773503823499, 45.67469665728], [5.0888320304231, 45.67702542226], [5.0942617281168, 45.682878871985], [5.1081345828339, 45.688028491968], [5.1048861162621, 45.700378923523], [5.1190903977565, 45.699708184787], [5.1310549291459, 45.707712334796], [5.1430567075695, 45.70002864286], [5.1592030475156, 45.714572205586], [5.1481741409716, 45.718787127083], [5.1339368816918, 45.733254459565], [5.1226621095427, 45.737811043006], [5.0945254918509, 45.739450682898], [5.089379542274, 45.74965948259], [5.093096251464, 45.766087895262], [5.0701066801383, 45.765478936083], [5.0595234976359, 45.782545469588], [5.0611720639467, 45.791532339886], [5.0893113585792, 45.784275046022], [5.101068799884, 45.813378958875], [5.1053919214171, 45.808445750031], [5.1255392074782, 45.811063396795], [5.144195778805, 45.804567863303], [5.1603637371378, 45.802317387422], [5.1768968364449, 45.793483254007], [5.1868098252677, 45.782095115203], [5.1915300805363, 45.771685350507], [5.207617133438, 45.771815785907], [5.2210769334942, 45.768454465895], [5.2668936711139, 45.789370837093], [5.2755531587012, 45.800893358874], [5.2889098684539, 45.811121994364], [5.2906249297479, 45.82025986169], [5.2998813382234, 45.837302685138], [5.3023555890522, 45.847951056741], [5.3091756488254, 45.854928769742], [5.3299682585029, 45.864099868222], [5.3409187894804, 45.880509325682], [5.3538322357139, 45.883269928025], [5.3709067264231, 45.874977947139], [5.3809175288182, 45.867234143477], [5.4131348727477, 45.852221679893], [5.4190015048359, 45.839680703571], [5.4349408141813, 45.831093859803], [5.4204751251472, 45.818886657011], [5.4226465285427, 45.80712278512], [5.4574039982348, 45.780996812177], [5.4825307295084, 45.754588985706], [5.5185478356945, 45.730162983976], [5.5272754539149, 45.715508313157], [5.5455440844452, 45.713591599398], [5.5534381913285, 45.708998294688], [5.5551113922636, 45.700261621079], [5.5711688852413, 45.696872630898], [5.5757522584809, 45.691788289582], [5.5703089690672, 45.684426548161], [5.5612096882931, 45.686985356436], [5.5559860481255, 45.697625399596], [5.5459463129561, 45.697327503887], [5.5451745235973, 45.687400229628], [5.5527423750432, 45.679883465959], [5.5541553698377, 45.671790582993], [5.563862776993, 45.674167414335], [5.5867550088025, 45.665298168862], [5.6030721965565, 45.647684669153], [5.6069435560033, 45.635482392274], [5.62374290574, 45.613268446443]]] }, "properties": { "code": "38", "nom": "Isère" } }, "constraints": "/query/dataset=health-markers/const=department.values.(all)/const=event_date.interval.(946857600:1500595200)/const=department.vales.(38)" }, { "feature": { "type": "Feature", "geometry": { "type": "Polygon", "coordinates": [[[6.8025153780901, 45.778372017386], [6.8056204903279, 45.748466106619], [6.8163461892763, 45.739522550345], [6.8111853327597, 45.73065029663], [6.8291131566154, 45.702831040263], [6.8416918546486, 45.699758351852], [6.8477523743945, 45.689376465007], [6.8685964773289, 45.680965439806], [6.8902954111672, 45.677517341592], [6.902535284798, 45.680938868689], [6.9065054377295, 45.674559463369], [6.9021374596942, 45.663743226821], [6.916286202296, 45.660011360485], [6.9171852994011, 45.650736949397], [6.9346140944773, 45.647093928516], [6.9666799933754, 45.654063379324], [6.9781568498682, 45.645387517519], [7.0006916861839, 45.639899750138], [7.0010463175509, 45.634973208788], [6.9860084427011, 45.62249039449], [6.9855421261112, 45.611104948043], [6.9778473846393, 45.589884647121], [6.9806967751279, 45.583323625828], [6.9953839096018, 45.575637066048], [6.9902484226223, 45.561160964462], [6.9945093026684, 45.546677250256], [6.9915104141831, 45.531278684704], [7.0038437540042, 45.520940469575], [7.0003315139353, 45.504414498664], [7.0224771388388, 45.49654847936], [7.0520544291456, 45.496249516678], [7.0563572963814, 45.489623728606], [7.0458504949934, 45.478351199929], [7.0542268132495, 45.472184344708], [7.0694234895786, 45.473884402143], [7.0997838903912, 45.469437750641], [7.1014832194722, 45.453864029477], [7.1146156812434, 45.44172035079], [7.1135165884052, 45.434196485823], [7.133848390776, 45.426564709361], [7.1475131268884, 45.423992978267], [7.1568873923079, 45.417008078104], [7.1842712160815, 45.407484371382], [7.17760043192, 45.389026414715], [7.1631811300703, 45.381359810968], [7.1588996003487, 45.370751749811], [7.1616596669718, 45.362453596128], [7.1528797089116, 45.353816021836], [7.1377390432018, 45.350806280555], [7.1321131760816, 45.341125471296], [7.1347132782574, 45.331243465627], [7.1263435309097, 45.326945010527], [7.1106925788126, 45.326508796443], [7.1123728281041, 45.315170813723], [7.1191793002337, 45.306692568243], [7.1229875004603, 45.294328291286], [7.136423190274, 45.28079819697], [7.1320835823333, 45.266961258797], [7.1375927179634, 45.255692980709], [7.1255846631745, 45.244603122115], [7.110603877569, 45.246346626842], [7.1065115700157, 45.239258758095], [7.0854359176976, 45.225881604766], [7.0796007060118, 45.21424401107], [7.0673372003279, 45.210085201319], [7.051179744193, 45.225334821034], [7.0427614515596, 45.225313603097], [7.030358820074, 45.217845107982], [7.0199925125511, 45.215876575558], [7.0003751823587, 45.217602834471], [6.989138474737, 45.210260447293], [6.9687620809781, 45.208057678984], [6.9538358712227, 45.184628781446], [6.954195544259, 45.179612452986], [6.9429030634006, 45.176188730221], [6.9430641979885, 45.17091084008], [6.9302666782212, 45.170963141126], [6.9069600182339, 45.166613555832], [6.8916010947342, 45.167033325671], [6.8858238474503, 45.154195417179], [6.8975633895087, 45.143009081491], [6.894376782376, 45.137373356732], [6.8747634572978, 45.13563631718], [6.8498552798828, 45.127164544748], [6.8422856917908, 45.135528185554], [6.8122710919045, 45.148356968553], [6.8013961759487, 45.150083145112], [6.7796480661915, 45.158028591752], [6.7679412928181, 45.159739939943], [6.7498942015229, 45.142719026683], [6.7392628844294, 45.136771576844], [6.7270392227155, 45.138490660871], [6.7121080083373, 45.144648738816], [6.6862136559676, 45.139756066415], [6.6800685047784, 45.140123130573], [6.6739820186998, 45.129496472881], [6.6657100684593, 45.122605577556], [6.6299923020059, 45.109324963809], [6.6155462835465, 45.121477875934], [6.5906851893034, 45.119010630972], [6.5765291374542, 45.123092743765], [6.5630788445458, 45.11303936929], [6.556730767951, 45.104079390462], [6.5297109874994, 45.0985691169], [6.5104239586159, 45.108998029314], [6.4995275838537, 45.10159781596], [6.4812555476638, 45.094138953543], [6.4893378703322, 45.068353912844], [6.4862360357216, 45.056075754404], [6.4728883939578, 45.056011644618], [6.4535295918669, 45.051837207667], [6.4433986588263, 45.055077367768], [6.4385899722107, 45.06258734764], [6.4002434258614, 45.063261148419], [6.3939107242634, 45.0618177275], [6.365073385182, 45.071290490956], [6.3735310876429, 45.084151804143], [6.3629265157708, 45.104492035764], [6.3344836229796, 45.122836461323], [6.3312951655489, 45.118123866818], [6.3019155994585, 45.108954317068], [6.2862810761543, 45.110160822134], [6.275502630793, 45.115299423706], [6.2605698000566, 45.12684420383], [6.2653779890371, 45.139607411594], [6.2489312476442, 45.149662771802], [6.2277116468863, 45.142717265929], [6.2183492305743, 45.145333575225], [6.2159372176736, 45.152163633175], [6.1892075903757, 45.163730483941], [6.1759369876508, 45.162361766933], [6.1690294070189, 45.154126275916], [6.1613170230868, 45.151005539601], [6.143792292215, 45.154552997649], [6.1619191434924, 45.188405431434], [6.1594722938627, 45.202449604679], [6.1378211482236, 45.213333187699], [6.1416935060053, 45.22232847567], [6.1272723570602, 45.233317943724], [6.1257002517953, 45.244269262231], [6.1385812548773, 45.256050997267], [6.1393900781341, 45.266560839079], [6.1325841534867, 45.272593012456], [6.1319486525639, 45.288285309432], [6.1417688736284, 45.299001113002], [6.1632323695733, 45.312838044143], [6.1844454256034, 45.317952251676], [6.1900932248736, 45.342443964482], [6.19476040795, 45.352244568075], [6.1803709629809, 45.35492081739], [6.1802922696297, 45.360409426774], [6.1916877134761, 45.369022157094], [6.1860529913803, 45.374350928001], [6.1774532351909, 45.393156916781], [6.154793328964, 45.409336349236], [6.1436456530595, 45.414580875157], [6.1324998100528, 45.433380436097], [6.1212683533751, 45.438895252904], [6.0974519491338, 45.432105098885], [6.0909753082569, 45.444016847857], [6.0658423549871, 45.444139208117], [6.0497526230096, 45.437920464227], [6.0085163401932, 45.453848085956], [6.0109047885983, 45.47320486613], [5.9893333893021, 45.476074199105], [5.9821187808525, 45.487027235821], [5.9661721637538, 45.492307753934], [5.9533584581804, 45.484809788706], [5.9164085799586, 45.47667987803], [5.9254150387228, 45.464593457788], [5.9149042257548, 45.436653554682], [5.904472446297, 45.432574848416], [5.9016155577899, 45.418032646134], [5.9090423346643, 45.408294208274], [5.9226358813528, 45.416818739345], [5.9281112911718, 45.415471973855], [5.9149860828604, 45.401349288339], [5.909612774011, 45.390400457607], [5.8910055457909, 45.392211292218], [5.8917060274354, 45.398132080514], [5.8797333382597, 45.406797743306], [5.8607139660775, 45.40924651344], [5.8542752462907, 45.4165640969], [5.8232128524879, 45.421771370243], [5.8074478270167, 45.426270640914], [5.7979610020218, 45.437123711786], [5.7820850307141, 45.440656144128], [5.7634821589831, 45.439042972367], [5.7597939416716, 45.435261281179], [5.7400977980128, 45.437349988759], [5.7322100567066, 45.453663170363], [5.7363772302151, 45.472535799856], [5.7190481261138, 45.484227733066], [5.7125099215192, 45.505293631893], [5.70267342317, 45.511196354762], [5.7011064065529, 45.517546444671], [5.6912470759998, 45.521805232869], [5.6901528196542, 45.52805100678], [5.6768487183882, 45.530475432419], [5.6717082687622, 45.536571381592], [5.6803575756273, 45.545047248369], [5.6695358905937, 45.563199459718], [5.654825526768, 45.570120639284], [5.6470817885996, 45.57674261279], [5.6430941654947, 45.585618310022], [5.6230208703548, 45.604282743022], [5.62374290574, 45.613268446443], [5.6316405396857, 45.611235124481], [5.63695250778, 45.621748588886], [5.6477926027919, 45.625976358255], [5.6494123534067, 45.633717345947], [5.6595309557102, 45.638684549186], [5.6781236866235, 45.638357085735], [5.6891819695463, 45.648501735062], [5.6836656752065, 45.661963741678], [5.6870609549933, 45.668165449596], [5.7083299077507, 45.683061321171], [5.7095817238803, 45.688831038827], [5.7010131804821, 45.702100635418], [5.7041230572664, 45.71092263715], [5.731324731181, 45.710147544457], [5.7487624468829, 45.705295781585], [5.7566806620664, 45.708732566891], [5.7647990972785, 45.720294878543], [5.7761557592359, 45.729222522213], [5.769838038757, 45.741303252362], [5.7819015428617, 45.743102925582], [5.78384046603, 45.751243783283], [5.7810286020002, 45.764959536359], [5.7868561787325, 45.822955096586], [5.7972199717522, 45.831056078142], [5.8036631085125, 45.8555780918], [5.8110472403323, 45.86737240276], [5.8285400922457, 45.909292435972], [5.8280692455776, 45.920463972756], [5.8228776189031, 45.931847125431], [5.8312301905898, 45.93845768164], [5.8338184185592, 45.934970601362], [5.8620989101739, 45.932404159946], [5.8657991558687, 45.918937453236], [5.8639923119064, 45.91291531862], [5.8690875747611, 45.886862766807], [5.8789441454491, 45.859760508659], [5.8734239275564, 45.838095623667], [5.885974070148, 45.825946919494], [5.9040441845732, 45.822537840692], [5.9050582571409, 45.812373466241], [5.9132162270288, 45.804144272156], [5.9291687016039, 45.806877104785], [5.9343721217477, 45.814546466017], [5.9485604331472, 45.810231609396], [5.962555366063, 45.812244082539], [5.9580636779393, 45.794917062293], [5.9809611163682, 45.795572407777], [5.9817452205322, 45.781181334315], [5.9739307725691, 45.774949967496], [5.9799040564948, 45.768947575193], [5.9948982938721, 45.762200067217], [6.0030607762844, 45.749527422399], [6.0128515303017, 45.748779570749], [6.0429455303571, 45.739097577502], [6.0527207239128, 45.748591921085], [6.075611236583, 45.740895531828], [6.1034234367071, 45.745054554666], [6.10083299013, 45.754193544969], [6.1030748256953, 45.763440195159], [6.1213793615519, 45.752668593025], [6.127906969992, 45.751705434989], [6.1428994551112, 45.761510794776], [6.166239206486, 45.755718187246], [6.1658270830033, 45.748885953864], [6.1783786439507, 45.747151190679], [6.1774190342075, 45.73984323683], [6.1822462092731, 45.733462501646], [6.1955441986055, 45.732330085742], [6.1897113419661, 45.704157323687], [6.194319616118, 45.69377532381], [6.2101473452824, 45.700435055747], [6.2142854320211, 45.70898418313], [6.2316514090283, 45.702752717419], [6.2294539875219, 45.698955738755], [6.2321247087245, 45.682198985672], [6.2396772877158, 45.685403937323], [6.2581175179422, 45.683589370573], [6.2615739463633, 45.686710375059], [6.2845906644549, 45.686263012136], [6.304826552827, 45.693294753292], [6.3217085573825, 45.693010739733], [6.3306327026354, 45.695531215444], [6.3412653460463, 45.711817142353], [6.3461832674281, 45.723712467269], [6.3532689092111, 45.732692357268], [6.3476791353535, 45.737171260988], [6.3703157001433, 45.752890460838], [6.3746675709662, 45.765706703413], [6.3685361711613, 45.772502949818], [6.3838464157156, 45.77805544991], [6.4060893301056, 45.792858964549], [6.4236722928903, 45.802445106386], [6.4308630057153, 45.820291359592], [6.44991867018, 45.837297648186], [6.4447971832877, 45.845503082677], [6.4537054607938, 45.855988611698], [6.4507523478857, 45.861321149515], [6.4622841966095, 45.868917313995], [6.4705662340798, 45.884693898827], [6.4937202988951, 45.890001524891], [6.5013594369083, 45.895225636351], [6.5090901071588, 45.90863369291], [6.5217033041707, 45.901408007254], [6.5420070408069, 45.895244356655], [6.5586799070897, 45.893088111068], [6.5729131150536, 45.877552911542], [6.5660557823526, 45.870781832548], [6.5684340912693, 45.863169115697], [6.53578724053, 45.862051424861], [6.5447591516362, 45.84852772759], [6.5522340049487, 45.826883589526], [6.5655501855053, 45.815706295722], [6.5772135491969, 45.816573014665], [6.5867081199374, 45.799816217231], [6.6017276524694, 45.795417388915], [6.6190023478384, 45.795615397056], [6.6375825199704, 45.800130775105], [6.6611884798758, 45.798909195187], [6.6742384781969, 45.783087871713], [6.6888265186739, 45.771350450683], [6.6898122556586, 45.761850928673], [6.6861426830802, 45.755325335528], [6.6986994083749, 45.743258811518], [6.6977838465696, 45.736581877151], [6.6904098405906, 45.72713731311], [6.7039483182394, 45.726700235782], [6.7119449400281, 45.72291946053], [6.742221719645, 45.748767103181], [6.7555088957599, 45.766356186055], [6.7693332671849, 45.770136455435], [6.7863107039258, 45.771491435411], [6.8025153780901, 45.778372017386]]] }, "properties": { "code": "73", "nom": "Savoie" } }, "constraints": "/query/dataset=health-markers/const=department.values.(all)/const=event_date.interval.(946857600:1500595200)/const=department.vales.(73)" }];

  ctn = new Map<string, any[]>();
  // minimum
  @ViewChild('ctnBmiMinLeft', { read: ViewContainerRef }) ctnBmiMinLeft: ViewContainerRef;
  @ViewChild('ctnBmiMinDead', { read: ViewContainerRef }) ctnBmiMinDead: ViewContainerRef;
  @ViewChild('ctnBmiMinGender', { read: ViewContainerRef }) ctnBmiMinGender: ViewContainerRef;
  @ViewChild('ctnBmiMinAge', { read: ViewContainerRef }) ctnBmiMinAge: ViewContainerRef;

  // maximum
  @ViewChild('ctnBmiMaxLeft', { read: ViewContainerRef }) ctnBmiMaxLeft: ViewContainerRef;
  @ViewChild('ctnBmiMaxDead', { read: ViewContainerRef }) ctnBmiMaxDead: ViewContainerRef;
  @ViewChild('ctnBmiMaxGender', { read: ViewContainerRef }) ctnBmiMaxGender: ViewContainerRef;
  @ViewChild('ctnBmiMaxAge', { read: ViewContainerRef }) ctnBmiMaxAge: ViewContainerRef;

  // distribution
  @ViewChild('ctnBmiDistLeft', { read: ViewContainerRef }) ctnBmiDistLeft: ViewContainerRef;
  @ViewChild('ctnBmiDistDead', { read: ViewContainerRef }) ctnBmiDistDead: ViewContainerRef;
  @ViewChild('ctnBmiDistGender', { read: ViewContainerRef }) ctnBmiDistGender: ViewContainerRef;
  @ViewChild('ctnBmiDistAge', { read: ViewContainerRef }) ctnBmiDistAge: ViewContainerRef;

  constructor(
    private dataService: DataService,
    private sharing: DataSharingService,

    private renderer2: Renderer2,
    private componentFactory: ComponentFactoryResolver,
  ) { }

  ngAfterViewInit() {
  }

  getCtn(ctn) {
    if (!this.ctn.has(ctn)) {
      this.ctn.set(ctn, []);
    }
    return this.ctn.get(ctn);
  }

  setCtn(ctn, any) {
    this.ctn.set(ctn, []);
  }

  updateDashboard() {
    this.updateInfo();

    this.updateCtnValue('ctn2', '/aggr=count', d3.format(''));
    this.updateCtnValueFun('ctn3', '/aggr=count' + '/const=user_id.values.(all)/group=user_id', this.getUniqueUsers, d3.format(''));

    // minimum
    this.updateCtnHistograms('ctnBmiMinLeft', this.ctnBmiMinLeft, 'has_left', '/aggr=quantile.value_t.(0)/const=marker.values.(1)/const=has_left.values.(all)/group=has_left');
    this.updateCtnHistograms('ctnBmiMinDead', this.ctnBmiMinDead, 'dead', '/aggr=quantile.value_t.(0)/const=marker.values.(1)/const=dead.values.(all)/group=dead');
    this.updateCtnHistograms('ctnBmiMinGender', this.ctnBmiMinGender, 'gender', '/aggr=quantile.value_t.(0)/const=marker.values.(1)/const=gender.values.(all)/group=gender');
    this.updateCtnHistograms('ctnBmiMinAge', this.ctnBmiMinAge, 'age', '/aggr=quantile.value_t.(0)/const=marker.values.(1)/const=age.values.(all)/group=age');

    // maximum
    this.updateCtnHistograms('ctnBmiMaxLeft', this.ctnBmiMaxLeft, 'has_left', '/aggr=quantile.value_t.(1)/const=marker.values.(1)/const=has_left.values.(all)/group=has_left');
    this.updateCtnHistograms('ctnBmiMaxDead', this.ctnBmiMaxDead, 'dead', '/aggr=quantile.value_t.(1)/const=marker.values.(1)/const=dead.values.(all)/group=dead');
    this.updateCtnHistograms('ctnBmiMaxGender', this.ctnBmiMaxGender, 'gender', '/aggr=quantile.value_t.(1)/const=marker.values.(1)/const=gender.values.(all)/group=gender');
    this.updateCtnHistograms('ctnBmiMaxAge', this.ctnBmiMaxAge, 'age',
      '/aggr=quantile.value_t.(1)/const=marker.values.(1)/const=age.values.(all)/group=age');

    // distributions
    this.updateCtnBoxplots('ctnBmiDistLeft', this.ctnBmiDistLeft, 'has_left', '/aggr=quantile.value_t.(0:0.25:0.5:0.75:1)/const=marker.values.(1)/const=has_left.values.(all)/group=has_left');
    this.updateCtnBoxplots('ctnBmiDistDead', this.ctnBmiDistDead, 'dead', '/aggr=quantile.value_t.(0:0.25:0.5:0.75:1)/const=marker.values.(1)/const=dead.values.(all)/group=dead');
    this.updateCtnBoxplots('ctnBmiDistGender', this.ctnBmiDistGender, 'gender', '/aggr=quantile.value_t.(0:0.25:0.5:0.75:1)/const=marker.values.(1)/const=gender.values.(all)/group=gender');
    this.updateCtnBoxplots('ctnBmiDistAge', this.ctnBmiDistAge, 'age',
      '/aggr=quantile.value_t.(0:0.25:0.5:0.75:1)/const=marker.values.(1)/const=age.values.(all)/group=age');
  }

  callback = () => { }

  getUniqueUsers = (data) => {
    return data[0].length;
  }

  updateInfo() {
    // reset widgets
    this.setCtn('ctnInfo', []);

    this.features.forEach((entry, index) => {
      this.getCtn('ctnInfo')[index] = '(' + entry.feature.properties.code + ') ' + entry.feature.properties.nom;
    });
  }

  getConstraints(index) {
    return this.features[index].constraints;
  }

  updateCtnValueFun(ctn, query, fun, formatter?) {
    if (!formatter) {
      formatter = d3.format('.2f');
    }

    // reset widgets
    this.setCtn(ctn, []);

    this.features.forEach((entry, index) => {
      this.dataService.query(this.getConstraints(index) + query).subscribe(result => {
        this.getCtn(ctn)[index] = formatter(fun(result));
      });
    });
  }

  updateCtnValue(ctn, query, formatter?) {
    if (!formatter) {
      formatter = d3.format('.2f');
    }

    // reset widgets
    this.setCtn(ctn, []);

    this.features.forEach((entry, index) => {
      this.dataService.query(this.getConstraints(index) + query).subscribe(result => {
        this.getCtn(ctn)[index] = formatter(result[0]);
      });
    });
  }

  updateCtnHistograms(ctn, ref, dim, query) {
    for (let i = 0; i < this.getCtn(ctn).length; ++i) {
      ref.remove(i);
    }

    // reset widgets
    this.setCtn(ctn, []);

    this.features.forEach((entry, index) => {
      const component = this.componentFactory.resolveComponentFactory(BarChartComponent);

      const componentRef = ref.createComponent(component);
      const componentInstance = <BarChartComponent>componentRef.instance;

      this.renderer2.addClass(componentRef.location.nativeElement, 'app-footer-item');

      componentInstance.register(dim, this.callback);
      componentInstance.setDataset('health');

      componentInstance.setFormatter(d3.format('.2s'));

      componentInstance.setYLabel('value');
      componentInstance.setXLabel('');

      componentInstance.setNextTerm(this.getConstraints(index) + query);

      // componentInstance.register(dim, this.setCategoricalData);
      this.getCtn(ctn).push({ key: 'none', type: 'categorical', widget: componentInstance });
    });
  }

  setBoxplotLine = (dim: string, constraints, value, self) => {
    let query = constraints +
      '/aggr=inverse.value_t.(' + value + ')' +
      '/const=' + dim + '.values.(all)' +
      '/group=' + dim;

    this.dataService.query(query).subscribe(data => {
      const extents = d3.extent(data[0], d => d[1] * 100);
      const scale = d3.scaleLinear<string, string>().
        // interpolate(d3.interpoateRgb).
        domain(extents as [number, number]).
        range(['rgb(240,240,240)', 'rgb(2,56,88)']);

      const colors = (<any[]>data[0]).map(d => scale(d[1] * 100));

      self.setColors(colors, scale);
    });
  }

  updateCtnBoxplots(ctn, ref, dim, query) {
    for (let i = 0; i < this.getCtn(ctn).length; ++i) {
      ref.remove(i);
    }

    // reset widgets
    this.setCtn(ctn, []);

    this.features.forEach((entry, index) => {
      const component = this.componentFactory.resolveComponentFactory(BoxPlotComponent);

      const componentRef = ref.createComponent(component);
      const componentInstance = <BoxPlotComponent>componentRef.instance;

      this.renderer2.addClass(componentRef.location.nativeElement, 'app-footer-item');

      // componentInstance.register(dim, this.callback);
      componentInstance.setDataset('health');

      // componentInstance.setFormatter(d3.format('.2s'));

      componentInstance.setYLabel('value');
      componentInstance.setXLabel('');

      componentInstance.setNextTerm(this.getConstraints(index) + query);

      componentInstance.registerConstraints(dim, this.getConstraints(index), this.setBoxplotLine);
      this.getCtn(ctn).push({ key: 'none', type: 'boxplot', widget: componentInstance });
    });
  }

  @HostListener('window:storage', ['$event'])
  onStorageChange(ev: StorageEvent) {
    if (ev.key === 'dim') {
      this.dim = JSON.parse(ev.newValue);
    } else if (ev.key === 'features') {
      console.log(ev.newValue);
      this.features = JSON.parse(ev.newValue);
      this.updateDashboard();
    }
  }

  ngOnInit() {
    this.updateDashboard();
  }
}
